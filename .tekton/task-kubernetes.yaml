apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: kubernetes-task
spec:
  inputs:
    params:
      - name: task-pvc
        description: the task pvc - this is the volume valid for the lifetime of the pipelinerun
      - name: clusterPipelineResourcesDirectoryFallback
        description: directory in the task-pvc that will be used as a fallback mechanism to provide the kubeconfig file
        default: tekton-cluster-pipeline-resources
    resources:
      - name: cluster
        type: cluster
  stepTemplate:
    env:
      # As Cluster Pipeline Resources are not properly updated after kubernetes cluster setup
      # use the kubeconfig copy fallback
      - name: KUBECONFIG
        value: /artifacts/$(inputs.params.clusterPipelineResourcesDirectoryFallback)/$(inputs.resources.cluster.name)/kubeconfig
  steps:
    - name: dosomething
      image: ibmcom/pipeline-base-image
      workingDir: /artifacts
      command: ["/bin/bash", "-c"]
      args:
        - |
          echo "** kubeconfig content **"
          #export KUBECONFIG=/artifacts/tekton-cluster-pipeline-resources/$(inputs.resources.cluster.name)/kubeconfig
          echo "KUBECONFIG=$KUBECONFIG"
          ls -l $(basename $KUBECONFIG)
          cat $KUBECONFIG
          echo "List K8S ns"
          kubectl get ns
      volumeMounts:
        - mountPath: /artifacts
          name: task-volume
        - mountPath: /cd-config
          name: cd-config-volume
  volumes:
    - name: steps-volume
      emptyDir: {}
    - name: task-volume
      persistentVolumeClaim:
        claimName: $(inputs.params.task-pvc)
    - name: cd-config-volume
      configMap:
        name: toolchain
        items:
        - key: toolchain.json
          path: toolchain.json