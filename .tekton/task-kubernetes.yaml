apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: kubernetes-context-execution
spec:
  inputs:
    params:
      - name: task-pvc
        description: the task pvc - this is the volume valid for the lifetime of the pipelinerun
      - name: task-pvc-mountpath
        default: /artifacts
      # As Cluster Pipeline Resources are not properly updated after kubernetes cluster setup
      # Allow user to specifiy kubeconfig copy fallback provided by fetch-iks-cluster-context task
      - name: clusterPipelineResourcesDirectory
        description: directory in which the kubeconfig file(s) for clusterPipelineResources are available
        default: /workspace
      - name: commands
        default:
          - | 
            echo "List K8S namespaces"
            kubectl get ns
          - |
            kubectl cluster-info
    resources:
      - name: cluster
        type: cluster
  stepTemplate:
    env:
      - name: KUBECONFIG
        value: $(inputs.params.clusterPipelineResourcesDirectory)/$(inputs.resources.cluster.name)/kubeconfig
  steps:
    - name: dosomething
      image: ibmcom/pipeline-base-image
      workingDir: $(inputs.params.task-pvc-mountpath)
      command: ["/bin/bash", "-c"]
      args: $(inputs.params.commands)
      volumeMounts:
        - mountPath: $(inputs.params.task-pvc-mountpath)
          name: task-volume
  volumes:
    - name: task-volume
      persistentVolumeClaim:
        claimName: $(inputs.params.task-pvc)
