apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: containerize-task
spec:
  inputs:
    params:
      - name: task-pvc
        description: the task pvc - this is the volume where the files (Dockerfile etc..) are expected to be
      # - name: additionalTags
      #   type: array
      #   default: []
    # resources:
    #   # TODO consider an optional git repository as the source of the image to build
    #   # when cd tekton support will be to tekton pipeline v 0.10
    #   - name: workspace
    #     type: git
    #     optional: true
  outputs:
    resources:
      - name: builtImage1
        type: image
      - name: builtImage2
        type: image
  steps:
    - name: build-image
      image: ibmcom/pipeline-base-image
      workingDir: /steps
      command: ["/bin/bash", "-c"]
      args:
        - |

          # This place/location is for tekton >= 0.0 
          # https://cd.foundation/blog/2019/12/12/whats-new-in-tekton-0-9/
          echo "Creating OCI image index - index.json - out of the build.log to reference image sha: $MANIFEST_SHA"
          echo "{}" | \
          jq --arg manifest_sha "sha256:1582e4175e25e835b94b0c59094d0413f9ceea6046493985549c07de2e090b69" '{schemaVersion:2,manifests:[{"mediaType": "application/vnd.oci.image.index.v1+json", size:1, digest:$manifest_sha}]}' 2>&1 | \
          tee /workspace/output/builtImage1/index.json

          echo "{}" | \
          jq --arg manifest_sha "sha256:2582e4175e25e835b94b0c59094d0413f9ceea6046493985549c07de2e090b69" '{schemaVersion:2,manifests:[{"mediaType": "application/vnd.oci.image.index.v1+json", size:2, digest:$manifest_sha}]}' 2>&1 | \
          tee /workspace/output/builtImage2/index.json

          # Copy also in the legacy - v0.7.0
          mkdir -p /builder/home/image-outputs/builtImage1
          cp /workspace/output/builtImage1/index.json /builder/home/image-outputs/builtImage1

          # Copy also in the legacy - v0.7.0
          mkdir -p /builder/home/image-outputs/builtImage2
          cp /workspace/output/builtImage2/index.json /builder/home/image-outputs/builtImage2

          ls -l -R /workspace

          ls -l -R /builder

      volumeMounts:
        - mountPath: /artifacts
          name: task-volume
        - mountPath: /steps
          name: steps-volume
  volumes:
    - name: steps-volume
      emptyDir: {}
    - name: task-volume
      persistentVolumeClaim:
        claimName: $(inputs.params.task-pvc)
